<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SF AOC Meteo | Full WMO</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-panel: #1e293b;
            --border: #334155;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --accent: #10b981; /* ECMWF Green */
            --danger: #ef4444; /* TS/FZRA Red */
            --warn: #f59e0b;   /* Warning Orange */
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* 顶部导航 */
        .navbar {
            flex: 0 0 auto;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 10px 20px;
            display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 50;
        }

        .brand { 
            font-size: 18px; font-weight: 700; letter-spacing: 0.5px; 
            display: flex; align-items: center; gap: 8px; white-space: nowrap;
        }
        .brand-tag { 
            background: var(--accent);
            font-size: 11px; padding: 2px 6px; 
            border-radius: 4px; color: #064e3b; font-weight: bold;
        }
        .disclaimer {
            font-size: 12px; color: #94a3b8; font-weight: normal; margin-left: 5px;
        }
        @media (max-width: 600px) {
            .disclaimer { display: none; }
        }

        /* 搜索框 */
        .search-container {
            display: flex; gap: 0;
            width: 100%; max-width: 300px;
        }
        input {
            flex: 1;
            background: #020617; border: 1px solid #475569; border-right: none;
            color: #fff; padding: 8px 12px;
            border-radius: 4px 0 0 4px;
            font-family: 'Consolas', monospace; font-weight: bold; text-transform: uppercase;
            outline: none; transition: 0.2s; min-width: 0;
        }
        input:focus { border-color: var(--accent); }
        button {
            background: var(--accent); border: none; padding: 0 20px;
            border-radius: 0 4px 4px 0; color: #064e3b; font-weight: 700; cursor: pointer; white-space: nowrap;
        }
        button:hover { filter: brightness(1.1); }

        /* 图表容器 */
        .main-view {
            flex: 1; padding: 10px; position: relative;
            display: flex; flex-direction: column;
        }
        #chart {
            flex: 1; width: 100%; border-radius: 8px; 
            background: var(--bg-panel); border: 1px solid var(--border);
        }

        /* 加载遮罩 */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15,23,42,0.95); z-index: 100;
            display: none; justify-content: center; align-items: center; flex-direction: column;
            text-align: center; padding: 20px;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #334155; border-top-color: var(--accent);
            border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .error-box {
            color: #ef4444; border: 1px solid #ef4444; background: rgba(239, 68, 68, 0.1);
            padding: 15px; border-radius: 6px; margin-top: 10px; font-family: monospace;
            max-width: 80%; display: none;
        }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="brand">
            SF Airlines AOC 
            <span class="brand-tag">ECMWF</span>
            <span class="disclaimer">本预测结果为数值预报客观结论，请勿直接应用于航班运行</span>
        </div>
        <div class="search-container">
            <input type="text" id="icao" value="ZHEC" placeholder="ZHEC" autocomplete="off" onkeydown="if(event.key==='Enter') query()">
            <button onclick="query()">查询</button>
        </div>
    </div>
    
    <div class="main-view">
        <div id="chart"></div>
        <div id="loader">
            <div class="spinner" id="spin-icon"></div>
            <div style="color: #10b981; font-weight: bold;" id="load-text">处理中...</div>
            <div class="error-box" id="error-msg"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. WMO 4677 代码表
        // ==========================================
        const WMO_CODE_MAP = {
            0: { cn: "晴 (SKC/CAVOK)", safe: true },
            1: { cn: "大部晴 (FEW)", safe: true },
            2: { cn: "部分多云 (SCT)", safe: true },
            3: { cn: "阴 (BKN/OVC)", safe: true },
            45: { cn: "雾 (FG)", safe: false },
            48: { cn: "凇雾 (FZFG)", safe: false, danger: true }, 
            51: { cn: "轻微毛毛雨 (-DZ)", safe: false },
            53: { cn: "毛毛雨 (DZ)", safe: false },
            55: { cn: "密毛毛雨 (+DZ)", safe: false },
            56: { cn: "轻微冻毛毛雨 (-FZDZ)", safe: false, danger: true },
            57: { cn: "密冻毛毛雨 (+FZDZ)", safe: false, danger: true },
            61: { cn: "小雨 (-RA)", safe: false },
            63: { cn: "中雨 (RA)", safe: false },
            65: { cn: "大雨 (+RA)", safe: false },
            66: { cn: "轻微冻雨 (-FZRA)", safe: false, danger: true },
            67: { cn: "强冻雨 (+FZRA)", safe: false, danger: true },
            71: { cn: "小雪 (-SN)", safe: false },
            73: { cn: "中雪 (SN)", safe: false },
            75: { cn: "大雪 (+SN)", safe: false },
            77: { cn: "雪粒 (SG/PL)", safe: false }, 
            80: { cn: "小阵雨 (-SHRA)", safe: false },
            81: { cn: "中阵雨 (SHRA)", safe: false },
            82: { cn: "强阵雨 (+SHRA)", safe: false },
            85: { cn: "小阵雪 (-SHSN)", safe: false },
            86: { cn: "大阵雪 (+SHSN)", safe: false },
            95: { cn: "雷暴 (TS)", safe: false, danger: true },
            96: { cn: "雷暴伴小冰雹 (TSGR)", safe: false, danger: true },
            99: { cn: "雷暴伴大冰雹 (TSGR)", safe: false, danger: true }
        };

        let EXTERNAL_DB = null;
        let myChart = null;
        let currentZoomInterval = 2; 

        function setLoader(show, text, error) {
            const el = document.getElementById('loader');
            const txt = document.getElementById('load-text');
            const errBox = document.getElementById('error-msg');
            const spinner = document.getElementById('spin-icon');
            
            el.style.display = show ? 'flex' : 'none';
            
            if (error) {
                spinner.style.display = 'none';
                txt.innerText = "Error";
                txt.style.color = '#ef4444';
                errBox.style.display = 'block';
                errBox.innerText = error;
            } else {
                spinner.style.display = 'block';
                txt.innerText = text || "Loading...";
                txt.style.color = '#10b981';
                errBox.style.display = 'none';
            }
        }

        // 辅助函数：角度转中文方位 (去"风"字)
        function getWindDirText(deg) {
            deg = deg % 360;
            if (deg < 0) deg += 360;
            
            if (deg >= 337.5 || deg < 22.5) return "北";
            if (deg >= 22.5 && deg < 67.5) return "东北";
            if (deg >= 67.5 && deg < 112.5) return "东";
            if (deg >= 112.5 && deg < 157.5) return "东南";
            if (deg >= 157.5 && deg < 202.5) return "南";
            if (deg >= 202.5 && deg < 247.5) return "西南";
            if (deg >= 247.5 && deg < 292.5) return "西";
            if (deg >= 292.5 && deg < 337.5) return "西北";
            return "";
        }

        async function findAirport(icao) {
            const AIRPORTS = {
                'ZHEC': {lat: 30.32, lon: 115.05, name: "鄂州花湖"}
            };

            if (AIRPORTS[icao]) return AIRPORTS[icao];

            if (!EXTERNAL_DB) {
                setLoader(true, "加载全球库...");
                try {
                    const res = await fetch('https://cdn.jsdelivr.net/gh/mwgg/Airports@master/airports.json');
                    if (!res.ok) throw new Error("加载失败");
                    EXTERNAL_DB = await res.json();
                } catch (e) {
                    console.warn("外部库加载失败");
                }
            }
            if (EXTERNAL_DB && EXTERNAL_DB[icao]) {
                const d = EXTERNAL_DB[icao];
                return { lat: d.lat, lon: d.lon, name: d.name };
            }
            throw new Error(`未找到代码 [${icao}]`);
        }

        async function query() {
            const code = document.getElementById('icao').value.trim().toUpperCase();
            if (!code || code.length !== 4) return alert("请输入4位代码");

            setLoader(true, "定位中...", null);

            try {
                const loc = await findAirport(code);
                setLoader(true, "获取ECMWF数据...", null);
                
                const params = new URLSearchParams({
                    latitude: loc.lat,
                    longitude: loc.lon,
                    hourly: 'temperature_2m,dewpoint_2m,precipitation,rain,snowfall,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,cloud_cover,relative_humidity_2m,pressure_msl',
                    wind_speed_unit: 'ms',
                    timezone: 'GMT',
                    forecast_days: 7,
                    timeformat: 'unixtime' 
                });

                const res = await fetch(`https://api.open-meteo.com/v1/ecmwf?${params.toString()}`);
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const data = await res.json();

                renderChart(data, code, loc.name);
                setLoader(false);

            } catch (err) {
                console.error(err);
                setLoader(true, null, err.message);
            }
        }

        function renderChart(data, code, name) {
            const dom = document.getElementById('chart');
            if (!myChart) {
                myChart = echarts.init(dom, 'dark');
                window.addEventListener('resize', () => myChart.resize());
                
                myChart.on('dataZoom', function (params) {
                    if(!myChart) return;
                    const opt = myChart.getOption();
                    if(!opt.dataZoom) return;
                    
                    const start = opt.dataZoom[0].start;
                    const end = opt.dataZoom[0].end;
                    const range = end - start; 
                    
                    const newInterval = range <= 43 ? 0 : 2; 

                    if (newInterval !== currentZoomInterval) {
                        currentZoomInterval = newInterval;
                        myChart.setOption({
                            xAxis: [
                                { axisLabel: { interval: currentZoomInterval } }, 
                                { axisLabel: { interval: currentZoomInterval } }
                            ]
                        });
                    }
                });
            }

            const h = data.hourly;
            
            const times = h.time.map((t, i) => {
                const d = new Date(t * 1000); 
                const hour = d.getUTCHours();
                const hourStr = String(hour).padStart(2,'0') + 'Z';
                
                if (hour === 0 || i === 0) {
                    const mm = String(d.getUTCMonth() + 1).padStart(2,'0');
                    const dd = String(d.getUTCDate()).padStart(2,'0');
                    return `${hourStr}\n${mm}-${dd}`;
                } else {
                    return `${hourStr}\n`;
                }
            });

            const colors = {
                wind: '#38bdf8', gust: '#7dd3fc', temp: '#fbbf24', dew: '#2dd4bf', 
                rain: '#3b82f6', snow: '#c084fc', cloud: '#a78bfa',
                humidity: '#22d3ee', 气压: '#4ade80'
            };
            
            currentZoomInterval = 2; 

            // 辅助函数：生成带颜色的圆点HTML
            const marker = (color) => `<span style="display:inline-block;margin-right:4px;border-radius:50%;width:10px;height:10px;background-color:${color};"></span>`;

            const option = {
                backgroundColor: 'transparent',
                legend: [
                    {
                        show: true, type: 'scroll',
                        // 修改1: top下移，right左移
                        top: 35, right: 50,
                        itemWidth: 14, itemHeight: 10, itemGap: 15,
                        backgroundColor: 'rgba(30, 41, 59, 0.7)', 
                        borderColor: '#475569', borderWidth: 1, borderRadius: 15,
                        padding: [8, 15], 
                        textStyle: { color: '#cbd5e1', fontSize: 12 },
                        pageIconColor: '#cbd5e1', pageTextStyle: { color: '#cbd5e1' },
                        data: ['风速', '阵风', '气温', '露点', '气压'],
                        selected: { '气压': false }
                    },
                    {
                        show: true, type: 'scroll',
                        // 修改2: top下移到54%避免遮挡上方X轴，right左移
                        top: '54%', right: 55, 
                        itemWidth: 14, itemHeight: 10, itemGap: 15,
                        backgroundColor: 'rgba(30, 41, 59, 0.7)', 
                        borderColor: '#475569', borderWidth: 1, borderRadius: 15,
                        padding: [8, 15], 
                        textStyle: { color: '#cbd5e1', fontSize: 12 },
                        pageIconColor: '#cbd5e1', pageTextStyle: { color: '#cbd5e1' },
                        data: ['降雨', '降雪', '云量', '相对湿度']
                    }
                ],
                title: {
                    text: `${code}-${name}`,
                    left: 20, top: 10,
                    textStyle: { color: '#fff', fontSize: 18 }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross', label: { backgroundColor: '#333' } },
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    borderColor: '#475569',
                    formatter: function(params) {
                        const i = params[0].dataIndex;
                        const wCode = h.weather_code[i];
                        const wDir = h.wind_direction_10m[i];
                        const pressure = h.pressure_msl[i];
                        const dewPoint = h.dewpoint_2m[i]; 
                        const wxInfo = WMO_CODE_MAP[wCode] || { cn: `未知 (${wCode})`, safe: true };
                        
                        const rawTime = h.time[i];
                        const d = new Date(rawTime * 1000);
                        const tipTime = `${d.getUTCDate()}日 ${String(d.getUTCHours()).padStart(2,'0')}Z`;
                        
                        let html = `<div style="border-bottom:1px solid #555;padding-bottom:5px;margin-bottom:5px;font-weight:bold">${tipTime}</div>`;
                        
                        html += `<div style="display:flex;justify-content:space-between;color:#fbbf24;font-weight:bold;margin-bottom:5px;"><span>天气： </span><span>${wxInfo.danger ? '⚠️ ' : ''}${wxInfo.cn}</span></div>`;
                        
                        const map = {};
                        params.forEach(p => map[p.seriesName] = p);

                        html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff">
                            <span>${marker(colors.wind)} 风向</span>
                            <span style="font-weight:bold;font-family:monospace">${getWindDirText(wDir)} (${wDir}°)</span>
                        </div>`;

                        if(map['风速']) {
                            html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff">
                                <span>${marker(colors.wind)} 风速</span>
                                <span style="font-weight:bold;font-family:monospace">${map['风速'].value} m/s</span>
                            </div>`;
                        }

                        if(map['阵风']) {
                            html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff">
                                <span>${marker(colors.gust)} 阵风</span>
                                <span style="font-weight:bold;font-family:monospace">${map['阵风'].value} m/s</span>
                            </div>`;
                        }

                        if(map['气温']) {
                            html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff">
                                <span>${marker(colors.temp)} 气温</span>
                                <span style="font-weight:bold;font-family:monospace">${map['气温'].value} °C</span>
                            </div>`;
                        }
                        
                        html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff">
                            <span>${marker(colors.dew)} 露点</span>
                            <span style="font-weight:bold;font-family:monospace">${dewPoint} °C</span>
                        </div>`;

                        if(map['相对湿度']) {
                            html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff">
                                <span>${marker(colors.humidity)} 相对湿度</span>
                                <span style="font-weight:bold;font-family:monospace">${map['相对湿度'].value} %</span>
                            </div>`;
                        }

                        if(map['云量']) {
                            html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff">
                                <span>${marker(colors.cloud)} 云量</span>
                                <span style="font-weight:bold;font-family:monospace">${map['云量'].value} %</span>
                            </div>`;
                        }

                        html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff">
                            <span>${marker(colors.气压)} 气压</span>
                            <span style="font-weight:bold;font-family:monospace">${pressure} hPa</span>
                        </div>`;

                        if(map['降雨'] && map['降雨'].value > 0) {
                            html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff">
                                <span>${marker(colors.rain)} 降雨</span>
                                <span style="font-weight:bold;font-family:monospace">${map['降雨'].value} mm</span>
                            </div>`;
                        }
                        if(map['降雪'] && map['降雪'].value > 0) {
                            html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff">
                                <span>${marker(colors.snow)} 降雪</span>
                                <span style="font-weight:bold;font-family:monospace">${map['降雪'].value} mm</span>
                            </div>`;
                        }

                        return html;
                    }
                },
                axisPointer: {
                    link: { xAxisIndex: 'all' },
                    label: { backgroundColor: '#777' }
                },
                // 修改: Grid布局优化，Grid[0]上移，Grid[1]下移
                grid: [
                    { top: 70, left: 30, right: 30, height: '38%' },
                    { top: '60%', left: 30, right: 30, height: '30%' } 
                ],
                xAxis: [
                    { 
                        type: 'category', data: times, gridIndex: 0, 
                        axisLine: { show: false }, axisTick: { show: true, alignWithLabel: true }, 
                        axisLabel: { 
                            show: true, 
                            color: '#94a3b8', 
                            fontSize: 10, 
                            interval: currentZoomInterval, 
                            formatter: function(value, index) {
                                const dir = h.wind_direction_10m[index];
                                return getWindDirText(dir);
                            }
                        }, 
                        markLine: null 
                    },
                    { 
                        type: 'category', data: times, gridIndex: 1, 
                        axisLine: { lineStyle: { color: '#475569' } }, 
                        axisLabel: { color: '#94a3b8', fontSize: 11, interval: currentZoomInterval, lineHeight: 14 }
                    }
                ],
                yAxis: [
                    { 
                        type: 'value', name: '米/秒', gridIndex: 0, min: 0, 
                        splitLine: { lineStyle: { type: 'dashed', color: '#334155' } }, 
                        axisLabel: { color: colors.wind }, 
                        nameTextStyle: { color: colors.wind } 
                    },
                    { 
                        type: 'value', name: '摄氏度', gridIndex: 0, 
                        position: 'right',
                        splitLine: { show: false }, 
                        axisLabel: { color: colors.temp }, 
                        nameTextStyle: { color: colors.temp } 
                    },
                    { type: 'value', name: '百分比', gridIndex: 1, max:100, splitLine:{lineStyle:{type:'dashed',color:'#334155'}}, axisLabel:{color:colors.cloud}, nameTextStyle:{color:colors.cloud} },
                    { type: 'value', name: '毫米', gridIndex: 1, splitLine:{show:false}, axisLabel:{color:colors.rain}, nameTextStyle:{color:colors.rain} },
                    { type: 'value', min: 950, max: 1050, gridIndex: 0, show: false } 
                ],
                dataZoom: [
                    { type: 'inside', xAxisIndex: [0, 1] },
                    { type: 'slider', xAxisIndex: [0, 1], bottom: 5, height: 15, borderColor:'transparent', fillerColor:'rgba(56,189,248,0.2)' }
                ],
                series: [
                    {
                        name: '风速', type: 'line', xAxisIndex: 0, yAxisIndex: 0,
                        data: h.wind_speed_10m,
                        smooth: true, showSymbol: false,
                        lineStyle: { color: colors.wind, width: 2 },
                        itemStyle: { color: colors.wind },
                        areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0, color:'rgba(56,189,248,0.3)'}, {offset:1, color:'rgba(56,189,248,0)'}]) }
                    },
                    {
                        name: '阵风', type: 'line', xAxisIndex: 0, yAxisIndex: 0,
                        data: h.wind_gusts_10m,
                        smooth: true, showSymbol: false,
                        lineStyle: { color: colors.gust, width: 1, type: 'dashed' },
                        itemStyle: { color: colors.gust }
                    },
                    {
                        name: '气压', type: 'line', xAxisIndex: 0, yAxisIndex: 4, 
                        data: h.pressure_msl,
                        smooth: true, showSymbol: false,
                        lineStyle: { color: colors.气压, width: 1, type: 'dashed' },
                        itemStyle: { color: colors.气压 }
                    },
                    {
                        name: '气温', type: 'line', xAxisIndex: 0, yAxisIndex: 1,
                        data: h.temperature_2m,
                        smooth: true, showSymbol: false,
                        lineStyle: { color: colors.temp, width: 2 },
                        itemStyle: { color: colors.temp }
                    },
                    {
                        name: '露点', type: 'line', xAxisIndex: 0, yAxisIndex: 1,
                        data: h.dewpoint_2m,
                        smooth: true, showSymbol: false,
                        lineStyle: { color: colors.dew, width: 1.5 },
                        itemStyle: { color: colors.dew }
                    },
                    {
                        name: '降雨', type: 'bar', stack: 'precip', xAxisIndex: 1, yAxisIndex: 3,
                        data: h.rain, itemStyle: { color: colors.rain }
                    },
                    {
                        name: '降雪', type: 'bar', stack: 'precip', xAxisIndex: 1, yAxisIndex: 3,
                        data: h.snowfall, itemStyle: { color: colors.snow }
                    },
                    {
                        name: '云量', type: 'line', xAxisIndex: 1, yAxisIndex: 2,
                        data: h.cloud_cover,
                        smooth: true, showSymbol: false,
                        lineStyle: { color: colors.cloud, width: 2, type: 'dashed' },
                        itemStyle: { color: colors.cloud },
                        z: 5
                    },
                    {
                        name: '相对湿度', type: 'line', xAxisIndex: 1, yAxisIndex: 2, 
                        data: h.relative_humidity_2m,
                        smooth: true, showSymbol: false,
                        lineStyle: { width: 0 }, 
                        itemStyle: { color: colors.humidity },
                        areaStyle: { opacity: 0.2, color: colors.humidity },
                        z: 4
                    }
                ]
            };

            myChart.setOption(option, true);
        }

        window.onload = function() {
            if(typeof echarts === 'undefined') {
                alert("组件加载失败");
            } else {
                query(); 
            }
        };
    </script>
</body>
</html>