<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SF AOC Meteo å…¨ç»´æ°”è±¡å†³ç­–ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-panel: #1e293b;
            --border: #334155;
            --text-main: #f1f5f9;
            --text-sub: #cbd5e1;
            --accent: #38bdf8;
            --tab-active: #0ea5e9;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            flex: 0 0 auto;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 0 15px;
            height: 50px;
            display: flex; 
            align-items: center; 
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 50;
            white-space: nowrap;
            overflow-x: auto;
        }
        .navbar::-webkit-scrollbar { display: none; }

        .brand { 
            font-size: 16px; font-weight: 700; letter-spacing: 0.5px; 
            display: flex; align-items: center; gap: 6px; 
            flex-shrink: 0;
        }
        .brand-tag { 
            background: var(--accent);
            font-size: 10px; padding: 1px 5px; 
            border-radius: 4px; color: #0f172a; font-weight: bold;
        }
        .disclaimer {
            font-size: 11px; color: #64748b; font-weight: normal; margin-left: 5px;
            padding-right: 10px; border-right: 1px solid #334155;
        }
        @media (max-width: 1100px) { .disclaimer { display: none; } }

        /* è§†å›¾åˆ‡æ¢æŒ‰é’®ç»„ */
        .view-toggles {
            display: flex;
            background: #0f172a;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 2px;
            flex-shrink: 0; 
        }
        .view-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .view-btn:hover { color: #fff; }
        .view-btn.active {
            background: var(--tab-active);
            color: #fff;
        }

        /* æœç´¢ä¸æ§åˆ¶åŒº */
        .controls {
            display: flex; gap: 8px; align-items: center;
            margin-left: auto;
            flex-shrink: 0;
        }
        
        .search-container {
            display: flex; gap: 0; width: 120px;
        }
        input[type="text"] {
            flex: 1;
            background: #020617; border: 1px solid #475569; border-right: none;
            color: #fff; padding: 4px 8px;
            border-radius: 4px 0 0 4px;
            font-family: 'Consolas', monospace; font-weight: bold; text-transform: uppercase;
            outline: none; transition: 0.2s; min-width: 0; font-size: 12px;
        }
        input[type="text"]:focus { border-color: var(--accent); }
        button.search-btn {
            background: var(--accent); border: none; padding: 0 10px;
            border-radius: 0 4px 4px 0; color: #0f172a; font-weight: 700; cursor: pointer; white-space: nowrap; font-size: 12px;
        }

        /* æ°”å€™æ§åˆ¶åŒº */
        .date-picker-wrapper {
            display: flex; align-items: center; gap: 5px;
            background: #0f172a; padding: 2px 8px; border-radius: 4px; border: 1px solid #334155;
        }
        .preset-select {
            background: #1e293b; color: #38bdf8; border: 1px solid #475569;
            padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: bold;
            outline: none; cursor: pointer;
        }
        .custom-date-group {
            display: flex; align-items: center; gap: 3px;
        }
        .date-input {
            background: #020617; border: 1px solid #475569;
            color: #fff; font-family: 'Consolas', monospace;
            padding: 2px 4px; border-radius: 4px;
            font-size: 11px; outline: none; width: 85px;
            cursor: text;
        }

        /* ä¸»è§†å›¾ */
        .main-view {
            flex: 1; 
            position: relative;
            overflow-y: auto; 
            padding: 10px;
            background: var(--bg-body);
        }

        #chart {
            width: 100%; 
            height: 1200px; 
            border-radius: 8px; 
            background: var(--bg-panel); 
            border: 1px solid var(--border);
        }

        /* é”æŒ‰é’® */
        .lock-container {
            position: absolute; 
            bottom: 5px;
            right: 15px;
            z-index: 200;
            height: 25px;
            display: flex; align-items: center;
        }
        .lock-btn {
            background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; 
            color: #94a3b8; padding: 0; border-radius: 4px;
            cursor: pointer; font-size: 14px; width: 30px; height: 100%;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s; 
        }
        .lock-btn.active {
            background: rgba(56, 189, 248, 0.2); 
            border-color: var(--accent);
            color: var(--accent);
        }
        .lock-btn:hover { color: #fff; border-color: #fff; }

        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15,23,42,0.95); z-index: 100;
            display: none; justify-content: center; align-items: center; flex-direction: column;
            text-align: center;
        }
        .progress-ring { width: 60px; height: 60px; position: relative; margin-bottom: 20px; }
        .progress-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .progress-ring circle { fill: none; stroke-width: 6; stroke-linecap: round; }
        .ring-bg { stroke: #334155; }
        .ring-val { stroke: #38bdf8; stroke-dasharray: 176; stroke-dashoffset: 176; transition: stroke-dashoffset 0.3s ease; }
        .loading-status { color: #38bdf8; font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .loading-detail { color: #94a3b8; font-size: 12px; font-family: monospace; margin-bottom: 20px; }
        .skip-btn {
            background: transparent; border: 1px solid #475569; color: #94a3b8;
            padding: 8px 20px; border-radius: 20px; font-size: 13px; cursor: pointer;
            transition: all 0.2s;
        }
        .skip-btn:hover { border-color: #ef4444; color: #ef4444; }
        .error-box {
            color: #ef4444; border: 1px solid #ef4444; background: rgba(239, 68, 68, 0.1);
            padding: 15px; border-radius: 6px; margin-top: 10px; font-family: monospace;
            max-width: 80%; display: none;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="brand">
            SF AOC 
            <span class="brand-tag">METEO</span>
            <span class="disclaimer">æœ¬é¢„æµ‹ç»“æœä¸ºæ•°å€¼é¢„æŠ¥å®¢è§‚ç»“è®º</span>
        </div>

        <div class="view-toggles">
            <button class="view-btn active" id="btn-hourly" onclick="switchView('hourly')" title="ECMWF Hourly (0-7å¤©)">ç²¾ç»†åŒ–é¢„æµ‹</button>
            <button class="view-btn" id="btn-ensemble" onclick="switchView('ensemble')" title="IFS ENS (0-15å¤©æ¦‚ç‡)">é›†åˆé¢„æŠ¥</button>
            <button class="view-btn" id="btn-weekly" onclick="switchView('weekly')" title="EC46 (15-45å¤©)">å»¶ä¼¸æœŸé¢„æŠ¥</button>
            <button class="view-btn" id="btn-monthly" onclick="switchView('monthly')" title="SEAS5 (1-6ä¸ªæœˆ)">å­£èŠ‚é¢„æŠ¥</button>
            <button class="view-btn" id="btn-climate" onclick="switchView('climate')" title="CMIP6 (1950-2050)">æ°”å€™é¢„ä¼°</button>
        </div>

        <div class="controls">
            <div class="date-picker-wrapper" id="climate-ctrl" style="display:none;">
                <select id="time-preset" class="preset-select" onchange="onPresetChange()">
                    <option value="next1y">ğŸš€ æœªæ¥1å¹´</option>
                    <option value="next5y">ğŸ”­ æœªæ¥5å¹´</option>
                    <option value="next10y">ğŸ”® æœªæ¥10å¹´</option>
                    <option value="past1y">âª å†å²1å¹´</option>
                    <option value="custom">ğŸ› ï¸ è‡ªå®šä¹‰</option>
                </select>
                <div id="custom-dates" class="custom-date-group" style="display:none;">
                    <input type="date" id="startDate" class="date-input" min="1950-01-01" max="2050-12-31">
                    <span style="color:#64748b">-</span>
                    <input type="date" id="endDate" class="date-input" min="1950-01-01" max="2050-12-31">
                    <button class="search-btn" style="padding:2px 6px;font-size:11px;" onclick="queryCustomClimate()">æ›´æ–°</button>
                </div>
            </div>

            <div class="search-container">
                <input type="text" id="icao" value="ZHEC" placeholder="CODE" onkeydown="if(event.key==='Enter') queryAll()">
                <button class="search-btn" onclick="queryAll()">Go</button>
            </div>
        </div>
    </div>
    
    <div class="main-view">
        <div id="chart"></div>
        <div class="lock-container">
            <button class="lock-btn" id="lockBtn" onclick="toggleLock()" title="é”å®š/è§£é” ç¼©æ”¾">ğŸ”“</button>
        </div>
    </div>

    <div id="loader">
        <div class="progress-ring">
            <svg>
                <circle class="ring-bg" cx="30" cy="30" r="28"></circle>
                <circle class="ring-val" id="ring-val" cx="30" cy="30" r="28"></circle>
            </svg>
        </div>
        <div class="loading-status" id="load-text">ç³»ç»Ÿåˆå§‹åŒ–...</div>
        <div class="loading-detail" id="load-detail">æ­£åœ¨è¿æ¥å…¨çƒæ°”è±¡æ•°æ®ä¸­å¿ƒ</div>
        <button class="skip-btn" onclick="skipLoading()">âš  è·³è¿‡ç­‰å¾…ï¼Œå¼ºåˆ¶æ¸²æŸ“</button>
        <div class="error-box" id="error-msg"></div>
    </div>

    <script>
        const AIRPORTS = {
            'ZHEC': {lat: 30.32, lon: 115.05, name: "é„‚å·èŠ±æ¹–"},
            'ZGSZ': {lat: 22.62, lon: 113.81, name: "æ·±åœ³å®å®‰"},
            'ZSHC': {lat: 30.23, lon: 120.43, name: "æ­å·è§å±±"},
            'ZBAA': {lat: 40.08, lon: 116.58, name: "åŒ—äº¬é¦–éƒ½"}
        };
        
        const VIEW_NAMES = {
            'hourly': 'ç²¾ç»†åŒ–é¢„æµ‹ (é€å°æ—¶)',
            'ensemble': 'é›†åˆé¢„æŠ¥ (IFS ENS)',
            'weekly': 'å»¶ä¼¸æœŸé¢„æŠ¥ (EC46)',
            'monthly': 'å­£èŠ‚é¢„æŠ¥ (SEAS5)',
            'climate': 'æ°”å€™é¢„ä¼° (CMIP6)'
        };

        const WMO_CODE_MAP = {
            0: { cn: "æ™´ (SKC/CAVOK)", safe: true }, 1: { cn: "å¤§éƒ¨æ™´ (FEW)", safe: true }, 2: { cn: "éƒ¨åˆ†å¤šäº‘ (SCT)", safe: true }, 3: { cn: "é˜´ (BKN/OVC)", safe: true }, 45: { cn: "é›¾ (FG)", safe: false }, 48: { cn: "å‡‡é›¾ (FZFG)", safe: false, danger: true }, 51: { cn: "è½»å¾®æ¯›æ¯›é›¨ (-DZ)", safe: false }, 53: { cn: "æ¯›æ¯›é›¨ (DZ)", safe: false }, 55: { cn: "å¯†æ¯›æ¯›é›¨ (+DZ)", safe: false }, 56: { cn: "è½»å¾®å†»æ¯›æ¯›é›¨ (-FZDZ)", safe: false, danger: true }, 57: { cn: "å¯†å†»æ¯›æ¯›é›¨ (+FZDZ)", safe: false, danger: true }, 61: { cn: "å°é›¨ (-RA)", safe: false }, 63: { cn: "ä¸­é›¨ (RA)", safe: false }, 65: { cn: "å¤§é›¨ (+RA)", safe: false }, 66: { cn: "è½»å¾®å†»é›¨ (-FZRA)", safe: false, danger: true }, 67: { cn: "å¼ºå†»é›¨ (+FZRA)", safe: false, danger: true }, 71: { cn: "å°é›ª (-SN)", safe: false }, 73: { cn: "ä¸­é›ª (SN)", safe: false }, 75: { cn: "å¤§é›ª (+SN)", safe: false }, 77: { cn: "é›ªç²’ (SG/PL)", safe: false }, 80: { cn: "å°é˜µé›¨ (-SHRA)", safe: false }, 81: { cn: "ä¸­é˜µé›¨ (SHRA)", safe: false }, 82: { cn: "å¼ºé˜µé›¨ (+SHRA)", safe: false }, 85: { cn: "å°é˜µé›ª (-SHSN)", safe: false }, 86: { cn: "å¤§é˜µé›ª (+SHSN)", safe: false }, 95: { cn: "é›·æš´ (TS)", safe: false, danger: true }, 96: { cn: "é›·æš´ä¼´å°å†°é›¹ (TSGR)", safe: false, danger: true }, 99: { cn: "é›·æš´ä¼´å¤§å†°é›¹ (TSGR)", safe: false, danger: true }
        };

        let EXTERNAL_DB = null;
        let myChart = null;
        let currentView = 'hourly'; 
        let isZoomLocked = false;
        let savedZoomStart = 0;
        let savedZoomEnd = 100;
        let currentHourlyZoomInterval = 2; 
        let isLoadingAborted = false;

        const DATA_CACHE = {
            hourly: null, ensemble: null, weekly: null, monthly: null, climate: null
        };
        
        let CURRENT_LOC = null;
        let CURRENT_CODE = "ZHEC";

        // ==========================================
        // 1. æ ¸å¿ƒäº¤äº’é€»è¾‘
        // ==========================================

        function switchView(view) {
            currentView = view;
            
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${view}`).classList.add('active');

            const climateCtrl = document.getElementById('climate-ctrl');
            if (view === 'climate') {
                climateCtrl.style.display = 'flex';
                if (!document.getElementById('startDate').value) {
                    onPresetChange(true); 
                }
            } else {
                climateCtrl.style.display = 'none';
            }

            if (!isZoomLocked) { savedZoomStart = 0; savedZoomEnd = 100; }

            if (DATA_CACHE[view] && CURRENT_LOC) {
                renderFromCache(view);
            } else {
                queryAll();
            }
        }

        function onPresetChange(silent = false) {
            const val = document.getElementById('time-preset').value;
            const customDiv = document.getElementById('custom-dates');
            const startIn = document.getElementById('startDate');
            const endIn = document.getElementById('endDate');
            const now = new Date();
            let sDate, eDate;

            if (val === 'custom') {
                customDiv.style.display = 'flex';
                if(!startIn.value) {
                    sDate = new Date(now); eDate = new Date(now); eDate.setFullYear(now.getFullYear() + 1);
                    startIn.value = sDate.toISOString().slice(0,10); endIn.value = eDate.toISOString().slice(0,10);
                }
                return; 
            } else {
                customDiv.style.display = 'none';
            }

            if (val === 'next1y') { sDate = new Date(now); eDate = new Date(now); eDate.setFullYear(now.getFullYear() + 1); }
            else if (val === 'next5y') { sDate = new Date(now); eDate = new Date(now); eDate.setFullYear(now.getFullYear() + 5); }
            else if (val === 'next10y') { sDate = new Date(now); eDate = new Date(now); eDate.setFullYear(now.getFullYear() + 10); }
            else if (val === 'past1y') { eDate = new Date(now); sDate = new Date(now); sDate.setFullYear(now.getFullYear() - 1); }

            if (sDate && eDate) {
                startIn.value = sDate.toISOString().slice(0,10); endIn.value = eDate.toISOString().slice(0,10);
                if (!silent) queryCustomClimate(); 
            }
        }

        function toggleLock() {
            isZoomLocked = !isZoomLocked;
            const btn = document.getElementById('lockBtn');
            btn.classList.toggle('active', isZoomLocked);
            btn.innerHTML = isZoomLocked ? 'ğŸ”’' : 'ğŸ”“';
            if(isZoomLocked && myChart) {
                const opt = myChart.getOption();
                if(opt.dataZoom && opt.dataZoom[0]) {
                    savedZoomStart = opt.dataZoom[0].start;
                    savedZoomEnd = opt.dataZoom[0].end;
                }
            }
        }

        async function findAirport(icao) {
            if (AIRPORTS[icao]) return AIRPORTS[icao];
            if (!EXTERNAL_DB) {
                updateLoadStatus(null, "è¿æ¥å…¨çƒæœºåœºæ•°æ®åº“...");
                try {
                    const res = await fetch('https://cdn.jsdelivr.net/gh/mwgg/Airports@master/airports.json');
                    if (!res.ok) throw new Error("DB Error");
                    EXTERNAL_DB = await res.json();
                } catch (e) { console.warn("Load Failed"); }
            }
            if (EXTERNAL_DB && EXTERNAL_DB[icao]) return { lat: EXTERNAL_DB[icao].lat, lon: EXTERNAL_DB[icao].lon, name: EXTERNAL_DB[icao].name };
            throw new Error(`æœªæ‰¾åˆ°ä»£ç  [${icao}]`);
        }

        function updateLoadStatus(percent, text) {
            if (isLoadingAborted) return;
            const el = document.getElementById('loader');
            const ringVal = document.getElementById('ring-val');
            const loadText = document.getElementById('load-text');
            const detailText = document.getElementById('load-detail');
            const errBox = document.getElementById('error-msg');

            el.style.display = 'flex';
            errBox.style.display = 'none';

            if (percent !== null) {
                const offset = 176 - (176 * percent) / 100;
                ringVal.style.strokeDashoffset = offset;
                loadText.innerText = `æ­£åœ¨åŠ è½½ ${Math.round(percent)}%`;
            }
            if (text) detailText.innerText = text;
        }

        function showError(msg) {
            if (isLoadingAborted) return;
            const loadText = document.getElementById('load-text');
            const detailText = document.getElementById('load-detail');
            const errBox = document.getElementById('error-msg');
            const ringVal = document.getElementById('ring-val');
            
            loadText.innerText = "åŠ è½½ä¸­æ–­";
            loadText.style.color = "#ef4444";
            ringVal.style.stroke = "#ef4444";
            detailText.innerText = "è¯·æ£€æŸ¥ç½‘ç»œæˆ–ç‚¹å‡»è·³è¿‡";
            errBox.style.display = 'block';
            errBox.innerText = msg;
        }

        function skipLoading() {
            isLoadingAborted = true;
            document.getElementById('loader').style.display = 'none';
            if (DATA_CACHE[currentView] && CURRENT_LOC) {
                renderFromCache(currentView);
            } else {
                const validKey = Object.keys(DATA_CACHE).find(k => DATA_CACHE[k]);
                if (validKey) {
                    switchView(validKey);
                } else {
                    if(myChart) myChart.clear();
                }
            }
        }

        async function queryAll() {
            const code = document.getElementById('icao').value.trim().toUpperCase();
            if (!code || code.length !== 4) return alert("è¯·è¾“å…¥4ä½ä»£ç ");
            
            CURRENT_CODE = code;
            isLoadingAborted = false;
            if (!isZoomLocked) { savedZoomStart = 0; savedZoomEnd = 100; }

            updateLoadStatus(5, "æ­£åœ¨å®šä½æœºåœº...");

            try {
                const loc = await findAirport(code);
                CURRENT_LOC = loc; 

                // FIX: 
                // 1. Ensemble: forecast_days -> 16 (0-15å¤©), add snowfall_sum, remove et0
                // 2. Weekly/Monthly: remove soil_moisture, shortwave_radiation
                const tasks = [
                    { key: 'hourly', label: 'ç²¾ç»†åŒ–é¢„æµ‹', url: 'https://api.open-meteo.com/v1/ecmwf', params: { hourly: 'temperature_2m,dewpoint_2m,precipitation,rain,snowfall,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,cloud_cover,relative_humidity_2m,pressure_msl', forecast_days: 7 } },
                    { key: 'ensemble', label: 'é›†åˆé¢„æŠ¥', url: 'https://ensemble-api.open-meteo.com/v1/ensemble', params: { models: 'ecmwf_ifs025', daily: 'temperature_2m_max,temperature_2m_min,precipitation_sum,snowfall_sum,wind_speed_10m_max,pressure_msl_mean', forecast_days: 16 } },
                    { key: 'weekly', label: 'å»¶ä¼¸æœŸé¢„æŠ¥', url: 'https://seasonal-api.open-meteo.com/v1/seasonal', params: { daily: 'temperature_2m_max,temperature_2m_min,temperature_2m_mean,precipitation_sum,rain_sum,snowfall_sum,wind_speed_10m_max,wind_gusts_10m_max,wind_direction_10m_dominant,pressure_msl_mean', forecast_days: 46 } },
                    { key: 'monthly', label: 'å­£èŠ‚é¢„æŠ¥', url: 'https://seasonal-api.open-meteo.com/v1/seasonal', params: { daily: 'temperature_2m_max,temperature_2m_min,temperature_2m_mean,precipitation_sum,rain_sum,snowfall_sum,wind_speed_10m_max,wind_gusts_10m_max,wind_direction_10m_dominant,pressure_msl_mean', forecast_days: 180 } },
                    { key: 'climate', label: 'æ°”å€™é¢„ä¼°', url: 'https://climate-api.open-meteo.com/v1/climate', params: { models: 'EC_Earth3P_HR', daily: 'temperature_2m_max,temperature_2m_min,temperature_2m_mean,precipitation_sum,snowfall_sum,wind_speed_10m_max,pressure_msl_mean,relative_humidity_2m_mean', start_date: getDateStr(0), end_date: getDateStr(365) } }
                ];

                const total = tasks.length;
                let completed = 0;

                await Promise.all(tasks.map(async (task) => {
                    if (isLoadingAborted) return;

                    let baseParams = new URLSearchParams({
                        latitude: loc.lat, longitude: loc.lon,
                        wind_speed_unit: 'ms', timezone: 'GMT', timeformat: 'unixtime'
                    });
                    
                    for (const [k, v] of Object.entries(task.params)) {
                        baseParams.append(k, v);
                    }

                    try {
                        const res = await fetch(`${task.url}?${baseParams.toString()}`);
                        if (!res.ok) throw new Error("HTTP Error");
                        const data = await res.json();
                        
                        let mName = "ECMWF";
                        if (task.key === 'hourly') mName = "ECMWF IFS (Hourly)";
                        if (task.key === 'climate') mName = "CMIP6 EC-Earth3P";
                        if (task.key === 'ensemble') mName = "ECMWF ENS (51 Members)";
                        if (task.key === 'weekly') mName = "ECMWF EC46 (Weekly)";
                        if (task.key === 'monthly') mName = "ECMWF SEAS5 (Monthly)";

                        if (task.key === 'hourly') {
                            DATA_CACHE[task.key] = { data: data, modelName: mName };
                        } else if (task.key === 'ensemble') {
                            DATA_CACHE[task.key] = { data: processData(data, 'ensemble'), modelName: mName };
                        } else {
                            DATA_CACHE[task.key] = { data: processData(data, task.key), modelName: mName };
                        }

                        completed++;
                        updateLoadStatus((completed / total) * 100, `è·å– ${task.label} æ•°æ®...`);

                    } catch (e) {
                        console.error(`Failed to load ${task.key}:`, e);
                        completed++;
                        updateLoadStatus((completed / total) * 100, `è·³è¿‡ ${task.label} (å¤±è´¥)`);
                    }
                }));

                if (!isLoadingAborted) {
                    document.getElementById('loader').style.display = 'none';
                    renderFromCache(currentView);
                }

            } catch (err) {
                showError(err.message);
            }
        }

        async function queryCustomClimate() {
            if (!CURRENT_LOC) return queryAll();

            setLoaderDisplay(true);
            const s = document.getElementById('startDate').value;
            const e = document.getElementById('endDate').value;
            
            let baseParams = new URLSearchParams({
                latitude: CURRENT_LOC.lat, longitude: CURRENT_LOC.lon,
                wind_speed_unit: 'ms', timezone: 'GMT', timeformat: 'unixtime',
                models: 'EC_Earth3P_HR',
                daily: 'temperature_2m_max,temperature_2m_min,temperature_2m_mean,precipitation_sum,snowfall_sum,wind_speed_10m_max,pressure_msl_mean,relative_humidity_2m_mean',
                start_date: s, end_date: e
            });

            try {
                const res = await fetch(`https://climate-api.open-meteo.com/v1/climate?${baseParams.toString()}`);
                const data = await res.json();
                DATA_CACHE['climate'] = { data: processData(data, 'climate'), modelName: "CMIP6 EC-Earth3P" };
                setLoaderDisplay(false);
                renderFromCache('climate');
            } catch (e) {
                alert("æ°”å€™æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¶é—´èŒƒå›´");
                setLoaderDisplay(false);
            }
        }

        function renderFromCache(view) {
            const cache = DATA_CACHE[view];
            if (!cache) {
                if (myChart) myChart.clear();
                return; 
            }

            if (view === 'hourly') {
                renderHourlyChart(cache.data, CURRENT_CODE, CURRENT_LOC.name, cache.modelName);
            } else {
                renderChart(cache.data, CURRENT_CODE, CURRENT_LOC.name, cache.modelName);
            }
        }

        function setLoaderDisplay(show) {
            const el = document.getElementById('loader');
            if (show) {
                el.style.display = 'flex';
                document.getElementById('load-text').innerText = "æ›´æ–°æ°”å€™æ•°æ®...";
                document.getElementById('ring-val').style.strokeDashoffset = 100;
            } else {
                el.style.display = 'none';
            }
        }

        function getDateStr(daysFromNow) {
            const d = new Date();
            d.setDate(d.getDate() + daysFromNow);
            return d.toISOString().slice(0, 10);
        }

        function getWindDirText(deg) {
            if (deg === null || deg === undefined) return "";
            deg = deg % 360; if (deg < 0) deg += 360;
            const dirs = ["åŒ—","ä¸œåŒ—","ä¸œ","ä¸œå—","å—","è¥¿å—","è¥¿","è¥¿åŒ—"];
            return dirs[Math.round(deg / 45) % 8];
        }

        function getModelUpdateTime(view) {
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            if (view === 'monthly') {
                let refDate = new Date(now);
                if (now.getDate() < 5) refDate.setMonth(refDate.getMonth() - 1);
                refDate.setDate(5);
                return refDate.toISOString().slice(0, 10);
            } else if (view === 'climate') {
                return "1950-2050 (CMIP6 Projections)";
            } else if (view === 'hourly') {
                return `${dateStr} ${now.getUTCHours()}:00Z`;
            } else {
                return dateStr;
            }
        }

        function getTodayAxisString(view) {
            const now = new Date();
            const d = String(now.getDate()).padStart(2, '0');
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const y = now.getFullYear();
            if (view === 'ensemble') return `${d}æ—¥`;
            if (view === 'climate') return `${y}-${m}-${d}`; 
            return `${m}-${d}`;
        }

        function processData(data, view) {
            if (view !== 'ensemble') return data.daily || data; 
            const d = data.daily;
            const len = d.time.length;
            const result = {
                time: d.time,
                tMax_mean: new Array(len).fill(0), tMax_min: new Array(len).fill(100), tMax_max: new Array(len).fill(-100),
                tMin_mean: new Array(len).fill(0), tMin_min: new Array(len).fill(100), tMin_max: new Array(len).fill(-100),
                precip_mean: new Array(len).fill(0), precip_max: new Array(len).fill(0),
                wind_mean: new Array(len).fill(0), wind_max: new Array(len).fill(0),
                pressure_mean: d.pressure_msl_mean || new Array(len).fill(1013),
                // æ–°å¢ Snowfall Sum å¤„ç†
                snow_mean: new Array(len).fill(0),
                members_count: 0
            };
            const keys = Object.keys(d);
            let memberCount = 0;
            keys.forEach(k => { if (k.includes('temperature_2m_max_member')) memberCount++; });
            
            if (memberCount === 0) return { ...d, isEnsemble: false };

            for (let i = 0; i < len; i++) {
                let tMaxSum = 0, tMinSum = 0, pSum = 0, wSum = 0, sSum = 0;
                let tMaxArr = [], tMinArr = [];
                for (let m = 0; m < memberCount; m++) {
                    const suffix = `_member${String(m).padStart(2, '0')}`;
                    let vTmax = d[`temperature_2m_max${suffix}`] ? d[`temperature_2m_max${suffix}`][i] : d[`temperature_2m_max`][i];
                    let vTmin = d[`temperature_2m_min${suffix}`] ? d[`temperature_2m_min${suffix}`][i] : d[`temperature_2m_min`][i];
                    let vP = d[`precipitation_sum${suffix}`] ? d[`precipitation_sum${suffix}`][i] : d[`precipitation_sum`][i];
                    let vW = d[`wind_speed_10m_max${suffix}`] ? d[`wind_speed_10m_max${suffix}`][i] : d[`wind_speed_10m_max`][i];
                    // å¤„ç† Snowfall
                    let vS = d[`snowfall_sum${suffix}`] ? d[`snowfall_sum${suffix}`][i] : (d[`snowfall_sum`] ? d[`snowfall_sum`][i] : 0);

                    if(vTmax !== undefined) {
                        tMaxSum += vTmax; tMaxArr.push(vTmax);
                        tMinSum += vTmin; tMinArr.push(vTmin);
                        pSum += vP; wSum += vW; sSum += vS;
                        result.precip_max[i] = Math.max(result.precip_max[i], vP);
                        result.wind_max[i] = Math.max(result.wind_max[i], vW);
                    }
                }
                result.tMax_mean[i] = (tMaxSum / memberCount).toFixed(1);
                result.tMin_mean[i] = (tMinSum / memberCount).toFixed(1);
                result.precip_mean[i] = (pSum / memberCount).toFixed(1);
                result.snow_mean[i] = (sSum / memberCount).toFixed(1);
                result.wind_mean[i] = (wSum / memberCount).toFixed(1);

                result.tMax_min[i] = Math.min(...tMaxArr); result.tMax_max[i] = Math.max(...tMaxArr);
                result.tMin_min[i] = Math.min(...tMinArr); result.tMin_max[i] = Math.max(...tMinArr);
            }
            result.isEnsemble = true;
            return result;
        }

        // ==========================================
        // 4. ç²¾ç»†åŒ–å›¾è¡¨æ¸²æŸ“ (Hourly) - 5 Grid
        // ==========================================
        function renderHourlyChart(data, code, name, modelInfo) {
            const dom = document.getElementById('chart');
            if (!myChart) {
                myChart = echarts.init(dom, 'dark');
                window.addEventListener('resize', () => myChart.resize());
            }
            myChart.clear();

            if (!data || !data.hourly || !data.hourly.time) return;

            const h = data.hourly;
            const updateStr = getModelUpdateTime('hourly');
            const initStr = `${modelInfo} | Update: ${updateStr}`;

            const times = h.time.map(t => {
                const d = new Date(t * 1000); 
                const hour = d.getUTCHours();
                return String(hour).padStart(2,'0') + 'Z'; 
            });

            // ç»Ÿä¸€è‰²æ¿
            const colors = {
                wind: '#38bdf8', gust: '#7dd3fc', temp: '#fbbf24', dew: '#2dd4bf', 
                rain: '#3b82f6', snow: '#c084fc', cloud: '#a78bfa',
                humidity: '#22d3ee', pressure: '#f59e0b',
                grid: '#334155', text: '#cbd5e1'
            };

            const nowTs = Date.now() / 1000;
            const nowIdx = h.time.findIndex(t => t >= nowTs);
            const nowLine = {
                symbol: ['none', 'none'], label: { show: false }, 
                lineStyle: { color: '#fff', type: 'dashed', width: 2, opacity: 0.6 }, 
                data: nowIdx !== -1 ? [{ xAxis: nowIdx }] : [], z: 100
            };

            const marker = (color) => `<span style="display:inline-block;margin-right:4px;border-radius:50%;width:10px;height:10px;background-color:${color};"></span>`;

            // Grid å¸ƒå±€
            const gridSettings = [
                { top: '10%', height: '12%', left: 60, right: 50 },  
                { top: '28%', height: '12%', left: 60, right: 50 }, 
                { top: '46%', height: '12%', left: 60, right: 50 }, 
                { top: '64%', height: '12%', left: 60, right: 50 }, 
                { top: '82%', height: '12%', left: 60, right: 50 } 
            ];

            // Legend: æ”¾åœ¨Gridä¸Šæ–¹çš„é—´éš™ä¸­
            const legendCommon = {
                type: 'scroll', orient: 'horizontal', icon: 'roundRect', itemWidth: 12, itemHeight: 8,
                backgroundColor: 'rgba(15, 23, 42, 0.85)', borderColor: '#334155', borderWidth: 1, borderRadius: 4, padding: [2, 6],
                textStyle: { color: colors.text, fontSize: 11 }
            };

            const legends = [
                { ...legendCommon, top: '8%', right: 50, data: [{name: 'é£é€Ÿ', itemStyle:{color: colors.wind}}, {name: 'é˜µé£', itemStyle:{color: colors.gust}}] },
                { ...legendCommon, top: '26%', right: 50, data: [{name: 'é™é›¨', itemStyle:{color: colors.rain}}, {name: 'é™é›ª', itemStyle:{color: colors.snow}}] },
                { ...legendCommon, top: '44%', right: 50, data: [{name: 'æ°”æ¸©', itemStyle:{color: colors.temp}}, {name: 'éœ²ç‚¹', itemStyle:{color: colors.dew}}] },
                { ...legendCommon, top: '62%', right: 50, data: [{name: 'äº‘é‡', itemStyle:{color: colors.cloud}}, {name: 'ç›¸å¯¹æ¹¿åº¦', itemStyle:{color: colors.humidity}}] },
                { ...legendCommon, top: '80%', right: 50, data: [{name: 'æ°”å‹', itemStyle:{color: colors.pressure}}] }
            ];

            const commonAxisFormatter = function(value, index) { 
                if (!h || !h.time || h.time[index] === undefined) return value;
                const d = new Date(h.time[index] * 1000);
                const hour = d.getUTCHours();
                if (hour === 0) {
                    const mm = String(d.getUTCMonth() + 1).padStart(2,'0');
                    const dd = String(d.getUTCDate()).padStart(2,'0');
                    return `${value}\n${mm}-${dd}`;
                }
                return `${value}\n`; 
            };

            const commonXAxisStyle = { lineStyle: { color: '#475569' } };
            const commonLabelStyle = { color: colors.text, fontSize: 11, interval: currentHourlyZoomInterval, lineHeight: 12 };

            const option = {
                backgroundColor: '#1e293b', 
                title: {
                    text: `{name|${code}-${name}} {tag|ç²¾ç»†åŒ–é¢„æµ‹} {info|${initStr}}`,
                    left: 20, top: 30, 
                    textStyle: { rich: {
                        name: { color: '#fff', fontSize: 18, fontWeight: 'bold' },
                        tag: { color: '#0f172a', backgroundColor: '#38bdf8', borderRadius: 3, padding: [2, 6], fontSize: 12, fontWeight: 'bold' },
                        info: { color: '#94a3b8', fontSize: 12, padding: [4, 0, 0, 10] } 
                    }}
                },
                tooltip: {
                    trigger: 'axis', axisPointer: { type: 'cross', label: { backgroundColor: '#333' } },
                    backgroundColor: 'rgba(15, 23, 42, 0.95)', borderColor: '#475569',
                    formatter: function(params) {
                        if(!params[0]) return '';
                        const i = params[0].dataIndex;
                        const wCode = h.weather_code[i];
                        const wDir = h.wind_direction_10m[i];
                        const pressure = h.pressure_msl[i];
                        const dewPoint = h.dewpoint_2m[i]; 
                        const wxInfo = WMO_CODE_MAP[wCode] || { cn: `Code ${wCode}`, safe: true };
                        
                        const rawTime = h.time[i];
                        const d = new Date(rawTime * 1000);
                        const tipTime = `${d.getUTCDate()}æ—¥ ${String(d.getUTCHours()).padStart(2,'0')}Z`;
                        
                        let html = `<div style="border-bottom:1px solid #555;padding-bottom:5px;margin-bottom:5px;font-weight:bold">${tipTime}</div>`;
                        html += `<div style="display:flex;justify-content:space-between;color:#fbbf24;font-weight:bold;margin-bottom:5px;"><span>å¤©æ°”ï¼š </span><span>${wxInfo.danger ? 'âš ï¸ ' : ''}${wxInfo.cn}</span></div>`;
                        
                        const map = {};
                        params.forEach(p => map[p.seriesName] = p);

                        html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff"><span>${marker(colors.wind)} é£å‘</span><span style="font-weight:bold;font-family:monospace">${getWindDirText(wDir)} (${wDir}Â°)</span></div>`;
                        if(map['é£é€Ÿ']) html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff"><span>${marker(colors.wind)} é£é€Ÿ</span><span style="font-weight:bold;font-family:monospace">${map['é£é€Ÿ'].value} m/s</span></div>`;
                        if(map['é˜µé£']) html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff"><span>${marker(colors.gust)} é˜µé£</span><span style="font-weight:bold;font-family:monospace">${map['é˜µé£'].value} m/s</span></div>`;
                        if(map['é™é›¨'] && map['é™é›¨'].value >= 0) html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff"><span>${marker(colors.rain)} é™é›¨</span><span style="font-weight:bold;font-family:monospace">${map['é™é›¨'].value} mm</span></div>`;
                        if(map['é™é›ª'] && map['é™é›ª'].value >= 0) html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff"><span>${marker(colors.snow)} é™é›ª</span><span style="font-weight:bold;font-family:monospace">${map['é™é›ª'].value} mm</span></div>`;
                        if(map['æ°”æ¸©']) html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff"><span>${marker(colors.temp)} æ°”æ¸©</span><span style="font-weight:bold;font-family:monospace">${map['æ°”æ¸©'].value} Â°C</span></div>`;
                        html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff"><span>${marker(colors.dew)} éœ²ç‚¹</span><span style="font-weight:bold;font-family:monospace">${dewPoint} Â°C</span></div>`;
                        if(map['ç›¸å¯¹æ¹¿åº¦']) html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff"><span>${marker(colors.humidity)} æ¹¿åº¦</span><span style="font-weight:bold;font-family:monospace">${map['ç›¸å¯¹æ¹¿åº¦'].value} %</span></div>`;
                        if(map['äº‘é‡']) html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff"><span>${marker(colors.cloud)} äº‘é‡</span><span style="font-weight:bold;font-family:monospace">${map['äº‘é‡'].value} %</span></div>`;
                        html += `<div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#fff"><span>${marker(colors.pressure)} æ°”å‹</span><span style="font-weight:bold;font-family:monospace">${pressure} hPa</span></div>`;

                        return html;
                    }
                },
                legend: legends,
                axisPointer: { link: { xAxisIndex: 'all' }, label: { backgroundColor: '#777' } },
                grid: gridSettings,
                xAxis: [
                    { 
                        type: 'category', data: times, gridIndex: 0, axisLine: commonXAxisStyle, axisTick: { show: true }, 
                        axisLabel: { ...commonLabelStyle, margin: 8, formatter: function(value, index) { const dir = getWindDirText(h.wind_direction_10m[index]); return `${dir}\n${commonAxisFormatter(value, index)}`; } }
                    },
                    { type: 'category', data: times, gridIndex: 1, axisLine: commonXAxisStyle, axisTick: { show: true }, axisLabel: { ...commonLabelStyle, formatter: commonAxisFormatter } },
                    { type: 'category', data: times, gridIndex: 2, axisLine: commonXAxisStyle, axisTick: { show: true }, axisLabel: { ...commonLabelStyle, formatter: commonAxisFormatter } },
                    { type: 'category', data: times, gridIndex: 3, axisLine: commonXAxisStyle, axisTick: { show: true }, axisLabel: { ...commonLabelStyle, formatter: commonAxisFormatter } },
                    { type: 'category', data: times, gridIndex: 4, axisLine: commonXAxisStyle, axisTick: { show: true }, axisLabel: { ...commonLabelStyle, formatter: commonAxisFormatter } }
                ],
                yAxis: [
                    { type: 'value', name: 'ç±³/ç§’', gridIndex: 0, min: 0, splitLine: { lineStyle: { type: 'dashed', color: colors.grid } }, axisLabel: { color: colors.wind }, nameTextStyle: { color: colors.wind, align:'left' } },
                    { type: 'value', name: 'æ¯«ç±³', gridIndex: 1, min: 0, splitLine: { lineStyle: { type: 'dashed', color: colors.grid } }, axisLabel: { color: colors.rain }, nameTextStyle: { color: colors.rain, align:'left' } },
                    { type: 'value', name: 'æ‘„æ°åº¦', gridIndex: 2, splitLine: { lineStyle: { type: 'dashed', color: colors.grid } }, axisLabel: { color: colors.temp }, nameTextStyle: { color: colors.temp, align:'left' } },
                    { type: 'value', name: 'ç™¾åˆ†æ¯”', gridIndex: 3, min: 0, max: 100, splitLine: { lineStyle: { type: 'dashed', color: colors.grid } }, axisLabel: { color: colors.cloud }, nameTextStyle: { color: colors.cloud, align:'left' } },
                    { type: 'value', name: 'ç™¾å¸•', gridIndex: 4, min: 980, max: 1040, splitLine: { lineStyle: { type: 'dashed', color: colors.grid } }, axisLabel: { color: colors.pressure }, nameTextStyle: { color: colors.pressure, align:'left' }, scale: true }
                ],
                dataZoom: [
                    { type: 'slider', xAxisIndex: [0, 1, 2, 3, 4], bottom: 5, right: 60, left: 50, height: 25, borderColor:'transparent', fillerColor:'rgba(56,189,248,0.2)', start: savedZoomStart, end: savedZoomEnd }
                ],
                series: [
                    { name: 'é£é€Ÿ', type: 'line', xAxisIndex: 0, yAxisIndex: 0, data: h.wind_speed_10m, smooth: true, showSymbol: false, lineStyle: { color: colors.wind, width: 2 }, itemStyle: { color: colors.wind }, areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0, color:'rgba(56,189,248,0.3)'}, {offset:1, color:'rgba(56,189,248,0)'}]) }, markLine: nowLine },
                    { name: 'é˜µé£', type: 'line', xAxisIndex: 0, yAxisIndex: 0, data: h.wind_gusts_10m, smooth: true, showSymbol: false, lineStyle: { color: colors.gust, width: 1, type: 'dashed' }, itemStyle: { color: colors.gust } },
                    { name: 'é™é›¨', type: 'bar', stack: 'precip', xAxisIndex: 1, yAxisIndex: 1, data: h.rain, itemStyle: { color: colors.rain }, markLine: nowLine },
                    { name: 'é™é›ª', type: 'bar', stack: 'precip', xAxisIndex: 1, yAxisIndex: 1, data: h.snowfall, itemStyle: { color: colors.snow } },
                    { name: 'æ°”æ¸©', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: h.temperature_2m, smooth: true, showSymbol: false, lineStyle: { color: colors.temp, width: 2 }, itemStyle: { color: colors.temp }, markLine: nowLine },
                    { name: 'éœ²ç‚¹', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: h.dewpoint_2m, smooth: true, showSymbol: false, lineStyle: { color: colors.dew, width: 1.5 }, itemStyle: { color: colors.dew } },
                    { name: 'äº‘é‡', type: 'line', xAxisIndex: 3, yAxisIndex: 3, data: h.cloud_cover, smooth: true, showSymbol: false, lineStyle: { color: colors.cloud, width: 2, type: 'dashed' }, itemStyle: { color: colors.cloud }, z: 5, markLine: nowLine },
                    { name: 'ç›¸å¯¹æ¹¿åº¦', type: 'line', xAxisIndex: 3, yAxisIndex: 3, data: h.relative_humidity_2m, smooth: true, showSymbol: false, lineStyle: { width: 0 }, itemStyle: { color: colors.humidity }, areaStyle: { opacity: 0.2, color: colors.humidity }, z: 4 },
                    { name: 'æ°”å‹', type: 'line', xAxisIndex: 4, yAxisIndex: 4, data: h.pressure_msl, smooth: true, showSymbol: false, lineStyle: { color: colors.pressure, width: 2 }, itemStyle: { color: colors.pressure }, markLine: nowLine }
                ]
            };

            myChart.setOption(option, true);
            
            myChart.off('dataZoom');
            myChart.on('dataZoom', function (params) {
                const opt = myChart.getOption();
                if(opt.dataZoom && opt.dataZoom[0]) {
                    const z = opt.dataZoom[0];
                    if (isZoomLocked) { savedZoomStart = z.start; savedZoomEnd = z.end; }
                }
                const totalHours = h.time.length;
                const visibleHours = (opt.dataZoom[0].end - opt.dataZoom[0].start) / 100 * totalHours;
                const newInterval = visibleHours <= 72 ? 0 : 2; 
                if (newInterval !== currentHourlyZoomInterval) {
                    currentHourlyZoomInterval = newInterval;
                    myChart.setOption({ xAxis: [ { axisLabel: { interval: newInterval } }, { axisLabel: { interval: newInterval } }, { axisLabel: { interval: newInterval } }, { axisLabel: { interval: newInterval } }, { axisLabel: { interval: newInterval } } ] });
                }
            });
        }

        // ==========================================
        // 5. é€šç”¨å›¾è¡¨æ¸²æŸ“ (Ensemble/Weekly/Monthly/Climate) - 4 Grid (å›å½’ç»å…¸å¸ƒå±€)
        // ==========================================
        function renderChart(d, code, name, modelInfo) {
            const dom = document.getElementById('chart');
            if (!myChart) {
                myChart = echarts.init(dom, 'dark');
                window.addEventListener('resize', () => myChart.resize());
            }
            myChart.clear();

            const updateStr = getModelUpdateTime(currentView);
            const todayAxisStr = getTodayAxisString(currentView);
            const isEns = d.isEnsemble === true;
            const viewName = VIEW_NAMES[currentView] || currentView.toUpperCase();

            const dates = d.time.map(t => {
                const dt = new Date(t * 1000);
                const m = String(dt.getUTCMonth()+1).padStart(2,'0');
                const dd = String(dt.getUTCDate()).padStart(2,'0');
                if (currentView === 'ensemble') return `${dd}æ—¥`;
                return `${m}-${dd}`;
            });

            // ç»Ÿä¸€é¢œè‰²
            const c = {
                tMax: '#ef4444', tMean: '#fbbf24', tMin: '#3b82f6', tArea: 'rgba(251, 191, 36, 0.2)', 
                rain: '#38bdf8', snow: '#c084fc',
                wind: '#10b981', gust: '#34d399',
                pressure: '#f59e0b', grid: '#334155', text: '#cbd5e1',
                humid: '#06b6d4'
            };

            // Grid Layout (Revert to 4)
            // 1. Temp, 2. Precip/Snow, 3. Wind, 4. Pressure
            const gridSettings = [
                { top: '10%', height: '14%', left: 60, right: 50 },
                { top: '32%', height: '14%', left: 60, right: 50 },
                { top: '54%', height: '14%', left: 60, right: 50 },
                { top: '76%', height: '14%', left: 60, right: 50 }
            ];

            let legendItems1 = [];
            if (isEns) {
                legendItems1 = [{name: 'æœ€é«˜æ¸©å‡å€¼', itemStyle: {color: c.tMax}}, {name: 'æœ€ä½æ¸©å‡å€¼', itemStyle: {color: c.tMin}}, {name: 'é›†åˆæ•£åº¦åŒºé—´', itemStyle: {color: c.tArea}}];
            } else {
                legendItems1 = [{name: 'æœ€é«˜æ¸©', itemStyle: {color: c.tMax}}, {name: 'å¹³å‡æ¸©', itemStyle: {color: c.tMean}}, {name: 'æœ€ä½æ¸©', itemStyle: {color: c.tMin}}];
            }

            let legendItems2 = [];
            if (isEns) {
                // é›†åˆé¢„æŠ¥å¢åŠ é™é›ª
                legendItems2 = [{name: 'å¹³å‡é™æ°´', itemStyle: {color: c.rain}}, {name: 'å¹³å‡é™é›ª', itemStyle: {color: c.snow}}, {name: 'æœ€å¤§å¯èƒ½é™æ°´', itemStyle: {color: c.rain}}];
            } else {
                legendItems2 = [{name: 'é™é›¨', itemStyle: {color: c.rain}}, {name: 'é™é›ª', itemStyle: {color: c.snow}}];
            }

            let legendItems3 = [];
            if (isEns) {
                legendItems3 = [{name: 'å¹³å‡é£é€Ÿ', itemStyle: {color: c.wind}}, {name: 'æœ€å¤§å¯èƒ½é£é€Ÿ', itemStyle: {color: c.gust}}];
            } else {
                legendItems3 = [{name: 'æœ€å¤§é£é€Ÿ', itemStyle: {color: c.wind}}, {name: 'æœ€å¤§é˜µé£', itemStyle: {color: c.gust}}];
            }

            let legendItems4 = [{name: 'æµ·å¹³é¢æ°”å‹', itemStyle: {color: c.pressure}}];
            // Climateæ¨¡å¼ä¸‹è‹¥æœ‰æ¹¿åº¦ï¼Œå¯æ”¾åœ¨ç¬¬4æ åŒè½´ï¼Œæˆ–å¿½ç•¥
            if (currentView === 'climate') legendItems4.push({name: 'ç›¸å¯¹æ¹¿åº¦', itemStyle: {color: c.humid}});

            const legendCommon = {
                type: 'scroll', orient: 'horizontal', icon: 'roundRect', itemWidth: 12, itemHeight: 8,
                backgroundColor: 'rgba(15, 23, 42, 0.85)', borderColor: '#334155', borderWidth: 1, borderRadius: 4, padding: [2, 6],
                textStyle: { color: c.text, fontSize: 11 }
            };

            const legends = [
                { ...legendCommon, top: '8%', right: 50, data: legendItems1 },
                { ...legendCommon, top: '30%', right: 50, data: legendItems2 },
                { ...legendCommon, top: '52%', right: 50, data: legendItems3 },
                { ...legendCommon, top: '74%', right: 50, data: legendItems4 }
            ];

            const commonXAxis = {
                type: 'category', data: dates, axisTick: { alignWithLabel: true },
                axisLine: { lineStyle: { color: '#475569' } },
                axisLabel: { 
                    color: c.text, interval: 'auto', fontSize: 11, lineHeight: 12,
                    formatter: function (value) {
                        if (value === todayAxisStr || value.endsWith(todayAxisStr)) return '{current|' + value + '}';
                        return value;
                    },
                    rich: { current: { color: '#facc15', fontWeight: 'bold' } }
                } 
            };

            let seriesList = [];
            
            if (isEns) {
                seriesList.push(
                    { name: 'é›†åˆæ•£åº¦åŒºé—´', type: 'line', xAxisIndex: 0, yAxisIndex: 0, data: d.tMax_max, lineStyle: { opacity: 0 }, areaStyle: { color: c.tArea, origin: 'start' }, stack: 'confidence-max', symbol: 'none' },
                    { name: 'é›†åˆæ•£åº¦åŒºé—´', type: 'line', xAxisIndex: 0, yAxisIndex: 0, data: d.tMax_min, lineStyle: { opacity: 0 }, areaStyle: { color: '#1e293b', origin: 'start' }, stack: 'confidence-min', symbol: 'none' }, 
                    { name: 'æœ€é«˜æ¸©å‡å€¼', type: 'line', xAxisIndex: 0, yAxisIndex: 0, data: d.tMax_mean, smooth: true, lineStyle: { width: 2, color: c.tMax }, itemStyle: { color: c.tMax } },
                    { name: 'æœ€ä½æ¸©å‡å€¼', type: 'line', xAxisIndex: 0, yAxisIndex: 0, data: d.tMin_mean, smooth: true, lineStyle: { width: 2, color: c.tMin }, itemStyle: { color: c.tMin } },
                    { name: 'å¹³å‡é™æ°´', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: d.precip_mean, itemStyle: { color: c.rain, opacity: 0.6 } },
                    // Ens Snowfall
                    { name: 'å¹³å‡é™é›ª', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: d.snow_mean, itemStyle: { color: c.snow, opacity: 0.8 } },
                    { name: 'æœ€å¤§å¯èƒ½é™æ°´', type: 'line', xAxisIndex: 1, yAxisIndex: 1, data: d.precip_max, lineStyle: { type: 'dotted', color: c.rain }, symbol: 'none' },
                    { name: 'å¹³å‡é£é€Ÿ', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: d.wind_mean, smooth: true, lineStyle: { width: 2, color: c.wind } },
                    { name: 'æœ€å¤§å¯èƒ½é£é€Ÿ', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: d.wind_max, lineStyle: { width: 1, type: 'dashed', color: c.gust } }
                );
            } else {
                seriesList.push(
                    { name: 'æœ€é«˜æ¸©', type: 'line', xAxisIndex: 0, yAxisIndex: 0, data: d.temperature_2m_max, smooth: true, lineStyle: { width: 1, color: c.tMax, type: 'dashed' }, itemStyle: { color: c.tMax } },
                    { name: 'å¹³å‡æ¸©', type: 'line', xAxisIndex: 0, yAxisIndex: 0, data: d.temperature_2m_mean, smooth: true, lineStyle: { width: 3, color: c.tMean }, itemStyle: { color: c.tMean } },
                    { name: 'æœ€ä½æ¸©', type: 'line', xAxisIndex: 0, yAxisIndex: 0, data: d.temperature_2m_min, smooth: true, lineStyle: { width: 1, color: c.tMin, type: 'dashed' }, itemStyle: { color: c.tMin } },
                    { name: 'é™é›¨', type: 'bar', stack: 'total', xAxisIndex: 1, yAxisIndex: 1, data: d.rain_sum || d.precipitation_sum, itemStyle: { color: c.rain } },
                    { name: 'é™é›ª', type: 'bar', stack: 'total', xAxisIndex: 1, yAxisIndex: 1, data: d.snowfall_sum, itemStyle: { color: c.snow } },
                    { name: 'æœ€å¤§é£é€Ÿ', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: d.wind_speed_10m_max, smooth: true, lineStyle: { width: 2, color: c.wind }, areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0, color:'rgba(16,185,129,0.3)'}, {offset:1, color:'rgba(16,185,129,0)'}]) } },
                    { name: 'æœ€å¤§é˜µé£', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: d.wind_gusts_10m_max, smooth: true, lineStyle: { width: 1, color: c.gust, type: 'dashed' }, itemStyle: { color: c.gust } }
                );
                
                if (currentView === 'climate') {
                    seriesList.push(
                        { name: 'ç›¸å¯¹æ¹¿åº¦', type: 'line', xAxisIndex: 3, yAxisIndex: 4, data: d.relative_humidity_2m_mean, smooth:true, itemStyle: { color: c.humid } }
                    );
                }
            }

            seriesList.push(
                { name: 'æµ·å¹³é¢æ°”å‹', type: 'line', xAxisIndex: 3, yAxisIndex: 3, data: isEns ? d.pressure_mean : (d.pressure_msl_mean || new Array(dates.length).fill(1013)), smooth: true, lineStyle: { width: 2, color: c.pressure }, areaStyle: { opacity: 0.1, color: c.pressure } }
            );
            
            // æ„å»º Y Axis
            let yAxes = [
                { type: 'value', name: 'æ‘„æ°åº¦', gridIndex: 0, splitLine: { lineStyle: { type: 'dashed', color: c.grid } }, axisLabel: { color: c.tMean } },
                { type: 'value', name: 'æ¯«ç±³', gridIndex: 1, splitLine: { lineStyle: { type: 'dashed', color: c.grid } }, axisLabel: { color: c.rain } },
                { type: 'value', name: 'ç±³/ç§’', gridIndex: 2, splitLine: { lineStyle: { type: 'dashed', color: c.grid } }, axisLabel: { color: c.wind } },
                { type: 'value', name: 'ç™¾å¸•', gridIndex: 3, scale: true, splitLine: { lineStyle: { type: 'dashed', color: c.grid } }, axisLabel: { color: c.pressure } }
            ];
            
            // Climate å³ä¾§æ¹¿åº¦è½´
            if (currentView === 'climate') {
                yAxes.push({ type: 'value', name: '%', gridIndex: 3, splitLine: { show: false }, axisLabel: { color: c.humid }, position: 'right', min: 0, max: 100 });
            } else {
                yAxes.push({ type: 'value', gridIndex: 3, show: false });
            }

            const option = {
                backgroundColor: '#1e293b',
                title: {
                    text: `{name|${code}-${name}} {tag|${viewName}} {info|${modelInfo} | Update: ${updateStr}}`,
                    left: 20, top: 30, 
                    textStyle: { rich: {
                        name: { color: '#fff', fontSize: 18, fontWeight: 'bold' },
                        tag: { color: '#0f172a', backgroundColor: isEns ? '#fbbf24' : c.rain, borderRadius: 3, padding: [2, 6], fontSize: 12, fontWeight: 'bold' },
                        info: { color: '#94a3b8', fontSize: 12, padding: [4, 0, 0, 10] } 
                    }}
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    borderColor: '#475569',
                    axisPointer: { type: 'cross', label: { backgroundColor: '#333' } },
                    formatter: function(params) {
                        const i = params[0].dataIndex;
                        const dateStr = dates[i];
                        const wDir = (d.wind_direction_10m_dominant && d.wind_direction_10m_dominant[i]) ? d.wind_direction_10m_dominant[i] : null;
                        let html = `<div style="border-bottom:1px solid #555;margin-bottom:6px;padding-bottom:2px;font-weight:bold;color:#fff">${dateStr}</div>`;
                        params.forEach(p => {
                            if (p.value !== undefined && !p.seriesName.includes('åŒºé—´')) {
                                let unit = '';
                                if (p.seriesName.includes('æ¸©')) unit = 'Â°C';
                                else if (p.seriesName.includes('é™') || p.seriesName.includes('æ°´') || p.seriesName.includes('é›ª')) unit = 'mm';
                                else if (p.seriesName.includes('é£')) unit = 'm/s';
                                else if (p.seriesName.includes('æ°”å‹')) unit = 'hPa';
                                else if (p.seriesName.includes('æ¹¿åº¦')) unit = '%'; 
                                html += `<div style="display:flex;justify-content:space-between;color:${p.color};min-width:150px;line-height:1.5;"><span>${p.marker}${p.seriesName}</span><span style="font-weight:bold;margin-left:10px">${p.value} ${unit}</span></div>`;
                            }
                        });
                        if (wDir !== null && wDir !== undefined) {
                             html += `<div style="border-top:1px dashed #555;margin-top:4px;padding-top:4px;color:#cbd5e1;font-size:11px">ğŸ§­ ä¸»å¯¼é£å‘: ${getWindDirText(wDir)} (${wDir}Â°)</div>`;
                        }
                        return html;
                    }
                },
                axisPointer: { link: { xAxisIndex: 'all' } },
                legend: legends,
                grid: gridSettings,
                xAxis: [ 
                    { ...commonXAxis, gridIndex: 0 }, 
                    { ...commonXAxis, gridIndex: 1 }, 
                    { ...commonXAxis, gridIndex: 2 }, 
                    { ...commonXAxis, gridIndex: 3 }
                ],
                yAxis: yAxes,
                dataZoom: [
                    { type: 'slider', xAxisIndex: [0, 1, 2, 3], bottom: 5, right: 60, left: 50, height: 25, borderColor:'transparent', fillerColor:'rgba(56,189,248,0.2)', start: savedZoomStart, end: savedZoomEnd }
                ],
                series: seriesList
            };

            myChart.setOption(option, true);
            myChart.off('dataZoom');
            myChart.on('dataZoom', function (params) {
                const opt = myChart.getOption();
                if(opt.dataZoom && opt.dataZoom[0]) {
                    const z = opt.dataZoom[0];
                    if (isZoomLocked) { savedZoomStart = z.start; savedZoomEnd = z.end; }
                }
            });
        }

        window.onload = function() {
            if(typeof echarts === 'undefined') {
                alert("ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            } else {
                queryAll(); 
            }
        };
    </script>
</body>
</html>